<!DOCTYPE html>
<html lang="ja">
<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>六甲学院物理部2023</title>
<meta name="description" content="六甲学院物理部の2023年度オンライン文化祭非公式サイト">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://rokkophysicsclub.github.io/rpc-2023/css/bootstrap.min.css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400,300,700,400italic">
<link rel="stylesheet" href="https://rokkophysicsclub.github.io/rpc-2023/css/font-awesome.min.css">
<link rel="stylesheet" href="https://rokkophysicsclub.github.io/rpc-2023/css/owl.carousel.css">
<link rel="stylesheet" href="https://rokkophysicsclub.github.io/rpc-2023/css/owl.theme.css">
<link rel="stylesheet" href="https://rokkophysicsclub.github.io/rpc-2023/css/header.css">
<link rel="stylesheet" href="https://rokkophysicsclub.github.io/rpc-2023/css/link_card.css">
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
 MathJax.Hub.Config({
 tex2jax: {
 inlineMath: [['$', '$'] ],
 displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
 }
 });
</script>


  <link href="https://rokkophysicsclub.github.io/rpc-2023/css/style.sea.css" rel="stylesheet" id="theme-stylesheet">

 

  
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  


<link href="https://rokkophysicsclub.github.io/rpc-2023/css/custom.css" rel="stylesheet">
<link rel="shortcut icon" href="https://rokkophysicsclub.github.io/rpc-2023/img/favicon.png">


<header>
<progress id="scroll_progress"></progress>
</header></head>
<body>
  <div id="all">
      <div class="container-fluid">
          <div class="row row-offcanvas row-offcanvas-left">
              <div id="sidebar" class="col-xs-6 col-sm-4 col-md-3 sidebar-offcanvas">
  <div class="sidebar-content">
    <h1 class="sidebar-heading"><a href="https://rokkophysicsclub.github.io/rpc-2023/">六甲学院物理部2023</a></h1>
    
      <p class="sidebar-p">六甲学院物理部の2023年度オンライン文化祭サイトです。（学校非公式）</p>
    
    <ul class="sidebar-menu">
      
        
        <li><a href="https://rokkophysicsclub.github.io/rpc-2023/welcome/">Welcome</a></li>
        
      
        
        <li><a href="https://rokkophysicsclub.github.io/rpc-2023/works/">Works</a></li>
        
      
        
        <li><a href="https://rokkophysicsclub.github.io/rpc-2023/links/">Links</a></li>
        
      
        
        <li><a href="https://rokkophysicsclub.github.io/rpc-2023/afterword/">Afterword</a></li>
        
      
        
        <hr size="1" style="margin-top: 15px;margin-bottom: 15px;">
        
      
        
        <li><a href="https://rokkophysicsclub.github.io/rpc-2023/members/">Members</a></li>
        
      
        
        <li><a href="https://rokkophysicsclub.github.io/rpc-2023/about/">About</a></li>
        
      
    </ul>
    <p class="social">
  
  
  
  <a href="https://twitter.com/rokkophysics" data-animate-hover="pulse" class="external twitter" title="Twitter" rel="me">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  
  <a href="https://github.com/RokkoPhysicsClub" data-animate-hover="pulse" class="external" title="GitHub" rel="me">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://www.youtube.com/channel/UCvLDGaFKdbpQ7vELdrUSyCw" data-animate-hover="pulse" class="external" title="YouTube" rel="me">
    <i class="fa fa-youtube"></i>
  </a>
  
  
</p>


    <div class="copyright">
      <p class="credit">
        
          &copy;2023 六甲学院物理部 |
        
        Template by <a href="https://bootstrapious.com/free-templates" class="external">Bootstrapious.com</a>

&amp; ported to Hugo by <a href="https://github.com/kishaningithub">Kishan B</a>

      </p>
    </div>
  </div>
</div>

              
<div class="col-xs-12 col-sm-8 col-md-9 content-column white-background">
  <div class="small-navbar visible-xs">
  <button type="button" data-toggle="offcanvas" class="btn btn-ghost pull-left"> <i class="fa fa-align-left"> </i>Menu</button>
  <h1 class="small-navbar-heading"><a href="https://rokkophysicsclub.github.io/rpc-2023/">六甲学院物理部2023</a></h1>
</div>

  <div class="row">
    <div class="col-lg-8">
      <div class="content-column-content">
         <h1>Path Tracing</h1>
         <div align="right">83rd 0x4C</div>
<h2 id="はじめに">はじめに</h2>
<p>最近、PS5ではレイトレーシングができるとか真のレイトレーシングモードとかの話題を聞きますよね。<br>
なので、今回は真のレイトレーシングである<code>Path Tracing</code>を実装しました。
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">リアルタイムパストレーサーつくった <a href="https://t.co/yyXxIUCveC">pic.twitter.com/yyXxIUCveC</a></p>&mdash; 0x4C (@async0x4c) <a href="https://twitter.com/async0x4c/status/1687241871708372992?ref_src=twsrc%5Etfw">August 3, 2023</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</p>
<h2 id="開発環境">開発環境</h2>
<ul>
<li>OS : Windows10</li>
<li>CPU : Intel🄬 core i7 11700</li>
<li>GPU : NVIDIA GeForce RTX 3060</li>
<li>RAM : DDR4-3200 48GB</li>
<li>Java : Java17</li>
</ul>
<h2 id="path-tracingの説明">Path Tracingの説明</h2>
<h3 id="そもそもpath-tracingって何">そもそもPath Tracingって何?</h3>
<p>Path Tracingというのは、超簡単に言うと光のシミュレーションです。<br>
もう少し厳密に言うと、光を粒子として考えた上で反射/屈折などの光学現象をシミュレートするというものです。
<img src="../../img/PathTracing/Ray_Trace.jpg" alt="Ray Trace"></p>
<h3 id="path-tracingは何が良いのか">Path Tracingは何が良いのか</h3>
<p>皆さんは1度ぐらいは3Dの綺麗なグラフィックスのゲームをプレイしたり動画を観たりしたことがあると思うのですが、それらは<code>ラスタライズ法</code>という方式で描画されています。<br>
<code>ラスタライズ法</code>というのは、キャラクターやオブジェクトなどを画面に投影して、その部分を光の位置を考えて塗りつぶすというものです。<br>
<img src="../../img/PathTracing/Rasterize.png" alt="ラスタライズ法">
この方法は、遮蔽や反射を考えないのでとても高速である反面、間接光や鏡の正確な表現ができません。<br>
<br>
一方、<code>Path Tracing</code>では画面のピクセルごとに光線を飛ばし、オブジェクトとの交差判定をとって反射/屈折などを繰り返すことで3Dの世界を描画するというものです。<br>
<img src="../../img/PathTracing/PT.png" alt="Path Tracing">
この方法は、圧倒的にリアルな表現ができる代わりにとても処理が遅く、ノイズも発生します。</p>
<h2 id="実装">実装</h2>
<h3 id="光線の発射">光線の発射</h3>
<p>今皆さんがこの記事を見るのに使っているスマホやらパソコンやらタブレットというものは、全ての画像を
<strong>「ピクセル」</strong>
という最小単位で表示しています。<br>
そのため、<code>Path Tracing</code>では全てのピクセルに対して光線を発射します。(一般的なディスプレイの場合はピクセルは2,073,600個程度)</p>
<h3 id="光線の計算">光線の計算</h3>
<p><code>Path Tracing</code>では、冒頭に説明した通り光線の計算が必要になります。<br>
具体的には、</p>
<ol>
<li>シーン内のすべてのポリゴンと交差判定をする</li>
<li>交差した中で最も近いポリゴンの法線を基に反射/屈折</li>
</ol>
<p>という手順を踏みます。<br>
以下にその(ほぼ)疑似コードを示します。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Triangle<span style="color:#f92672">[]</span> triangles<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> triangle_count<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Triangle <span style="color:#a6e22e">get_nearest_triangle</span><span style="color:#f92672">(</span>Ray ray<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>  Triangle t<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span>0<span style="color:#f92672">;</span>i<span style="color:#f92672">&lt;</span>triangle_count<span style="color:#f92672">;</span>i<span style="color:#f92672">++){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>is_hit<span style="color:#f92672">(</span>ray<span style="color:#f92672">,</span>triangles<span style="color:#f92672">[</span>i<span style="color:#f92672">])){</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>nearer_than<span style="color:#f92672">(</span>t<span style="color:#f92672">,</span>triangles<span style="color:#f92672">[</span>i<span style="color:#f92672">]))</span>t<span style="color:#f92672">=</span>triangles<span style="color:#f92672">[</span>i<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> t<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ray <span style="color:#a6e22e">sample_direction</span><span style="color:#f92672">(</span>Ray ray<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>  Triangle triangle<span style="color:#f92672">=</span>get_nearest_triangle<span style="color:#f92672">(</span>ray<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>is_opaque<span style="color:#f92672">(</span>triangle<span style="color:#f92672">)){</span>
</span></span><span style="display:flex;"><span>    ray<span style="color:#f92672">.</span><span style="color:#a6e22e">reflect</span><span style="color:#f92672">(</span>triangle<span style="color:#f92672">.</span><span style="color:#a6e22e">normal</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    ray<span style="color:#f92672">.</span><span style="color:#a6e22e">refract</span><span style="color:#f92672">(</span>triangle<span style="color:#f92672">.</span><span style="color:#a6e22e">normal</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> ray<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="bsdf">BSDF</h3>
<p><code>Path Tracing</code>において物理的に正しい描画をするには、当然物体の材質も物理的に正しい物である必要があります。<br>
そこで、<code>BSDF(Bidirectional Scattaring Distribution Function,双方向散乱分布関数)</code>というものが必要になります。<br>
また、<code>BSDF</code>というのは反射の特性を表現する<code>BRDF(Bidirectional Reflectance Distribution Function,双方向反射率分布関数)</code>と透過の特性を表現する<code>BTDF(Bidirectional Transmission Distribution Function,双方向透過率分布関数)</code>の和によって表され、これらは</p>
<ol>
<li>表面色</li>
<li>放射色</li>
<li>スペキュラー</li>
<li>メタリック</li>
<li>粗さ</li>
<li>IOR</li>
<li>透過率</li>
</ol>
<p>のパラメータを持ちます。</p>
<h3 id="ggx">GGX</h3>
<p>先ほど説明した<code>BRDF</code>を実装するために、今回は<code>GGX</code>というモデルを使います。<br>
<code>GGX</code>というのは、<code>Microfacet理論</code>という粗い物体は表面にある小さな凹凸を仮定することで表現できるという理論を利用したモデルで、</p>
<ul>
<li>鏡面反射の強さを決めるF(フレネル項)</li>
<li>表面の凹凸の強さを決めるD(法線分布関数)</li>
<li>凹凸による遮蔽を計算するG(マスキングシャドウ関数)</li>
</ul>
<p>によって構成され、
$$ \dfrac{F\cdot D\cdot G}{4 (\vec{n}\cdot \vec{w_o}) \cdot (\vec{n}\cdot \vec{w_i}) } $$
という式で計算することができます。<br>
<br>
↓GGXのテストの画像。背景の都合でノイズが多い。
<img src="../../img/PathTracing/materials.png" alt="Materials"></p>
<h3 id="背景">背景</h3>
<p>今回の<code>Path Tracer</code>には背景画像を読み込む機能を実装しています。<br>
背景画像といえば、皆さんが普段使っている<code>jpeg</code>や<code>png</code>を思い浮かべるかもしれませんが、それらの形式の画像は明るさを0~255の間に切り詰めてしまうので正確な太陽の明るさを表すことができません。なので、Path Tracingにおいては<code>hdri</code>や<code>exr</code>といったより広範囲の明るさを表現できる形式を使います。</p>

         
      </div>
    </div>
  </div>
</div>

          </div>
      </div>
  </div>
  <script src="https://rokkophysicsclub.github.io/rpc-2023/js/jquery.min.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/bootstrap.min.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/jquery.cookie.js"> </script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/ekko-lightbox.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/jquery.scrollTo.min.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/masonry.pkgd.min.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/imagesloaded.pkgd.min.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/owl.carousel.min.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/front.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/jquery.xdomainajax.js"></script>
<script src="https://rokkophysicsclub.github.io/rpc-2023/js/header.js"></script>



</body>
</html>
